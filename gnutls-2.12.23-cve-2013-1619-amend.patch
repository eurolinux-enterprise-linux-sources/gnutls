diff --git a/lib/gnutls_cipher.c b/lib/gnutls_cipher.c
index 2835121..d6af7ae 100644
--- a/lib/gnutls_cipher.c
+++ b/lib/gnutls_cipher.c
@@ -506,8 +506,10 @@ _gnutls_ciphertext2compressed (gnutls_session_t session,
   unsigned int pad = 0;
   int length;
   uint16_t blocksize;
-  int ret, i, pad_failed = 0;
+  int ret, i;
   opaque preamble[PREAMBLE_SIZE];
+  unsigned int tmp_pad_failed = 0;
+  unsigned int pad_failed = 0;
   int preamble_size = 0;
   int ver = gnutls_protocol_get_version (session);
   int hash_size = _gnutls_hash_get_algo_len (params->mac_algorithm);
@@ -567,12 +569,14 @@ _gnutls_ciphertext2compressed (gnutls_session_t session,
        * because there is a timing channel in that memory access (in certain CPUs).
        */
       if (_gnutls_version_has_variable_padding (ver) && pad_failed == 0)
-        for (i = 2; i <= pad; i++)
+        for (i = 2; i <= MIN(256, ciphertext.size); i++)
           {
-            if (ciphertext.data[ciphertext.size - i] != pad)
-              pad_failed = GNUTLS_E_DECRYPTION_FAILED;
+            tmp_pad_failed |= (ciphertext.data[ciphertext.size - i] != pad);
+            pad_failed |= ((i <= (1+pad)) & (tmp_pad_failed));
           }
-          
+
+      pad_failed |= 1+pad > ((int) ciphertext.size - hash_size);
+
       if (pad_failed)
         pad = 0;
       length = ciphertext.size - hash_size - pad - 1;
